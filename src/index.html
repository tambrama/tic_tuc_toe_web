<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #fff0f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #ff69b4;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .cell {
            aspect-ratio: 1;
            font-size: 2.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #ffeef2;
            border: 2px solid #ffb6c1;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .cell:hover {
            background: #ffdde5;
        }

        .cell.x {
            color: #ff1493;
        }

        .cell.o {
            color: #4682b4;
        }

        .controls {
            text-align: center;
            margin: 20px 0;
        }

        .controls button {
            margin: 5px;
            padding: 10px 15px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            background: #ffb6c1;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }

        .controls button:hover {
            background: #ff69b4;
        }

        .controls button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .game-info {
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 10px;
        }

        .status,
        .game-id {
            font-weight: bold;
            margin: 5px 0;
        }

        .message {
            color: #ff69b4;
            font-style: italic;
        }

        .instructions {
            margin-top: 20px;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 10px;
        }

        .auth-form {
            margin: 20px 0;
        }

        .auth-form input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #ffb6c1;
            border-radius: 10px;
            font-size: 1em;
            box-sizing: border-box;
        }

        .auth-form button {
            width: 48%;
            margin: 5px 1%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: #ffb6c1;
            color: white;
            font-size: 1em;
            cursor: pointer;
        }

        .auth-form button:hover {
            background: #ff69b4;
        }
    </style>
</head>

<body>
    <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="container" id="authScreen">
        <h1>üå∏ –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
        <div class="auth-form">
            <input type="text" id="login" placeholder="–õ–æ–≥–∏–Ω (–º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞)" />
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" />
            <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <button onclick="login()">–í–æ–π—Ç–∏</button>
        </div>
        <div class="instructions" style="margin-top: 20px;">
            <h3>üí° –°–æ–≤–µ—Ç:</h3>
            <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å, —á—Ç–æ–±—ã –∏–≥—Ä–∞—Ç—å –æ—Ç —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏!</p>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –∏–≥—Ä—ã (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç) -->
    <div class="container" id="gameScreen" style="display:none;">
        <h1>üå∏ –ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ üå∏</h1>

        <div class="game-info">
            <div class="status" id="status">–°—Ç–∞—Ç—É—Å: –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º</div>
            <div class="message" id="message">–£–¥–∞—á–∏! üíñ</div>
            <div class="game-id">ID –∏–≥—Ä—ã: <span id="gameId">-</span></div>
            <div class="game-id">–í—ã: <span id="userLogin">-</span></div>
        </div>

        <div class="board" id="board">
            <!-- –ö–ª–µ—Ç–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
        </div>

        <div class="controls" id="controls">
            <!-- –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã —á–µ—Ä–µ–∑ JS -->
        </div>

        <div class="instructions">
            <h3>üíï –ö–∞–∫ –∏–≥—Ä–∞—Ç—å:</h3>
            <ul>
                <li>–í—ã –∏–≥—Ä–∞–µ—Ç–µ –∫—Ä–µ—Å—Ç–∏–∫–∞–º–∏ (X)</li>
                <li>–ë–æ—Ç –∏–ª–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫ ‚Äî –Ω–æ–ª–∏–∫–∞–º–∏ (O)</li>
                <li>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ø—É—Å—Ç—É—é –∫–ª–µ—Ç–∫—É, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥</li>
                <li>–ü–æ–±–µ–∂–¥–∞–µ—Ç —Ç–æ—Ç, –∫—Ç–æ —Å–æ–±–µ—Ä—ë—Ç –ª–∏–Ω–∏—é –∏–∑ 3 —Å–≤–æ–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤</li>
            </ul>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8081';
        let currentGameId = null;
        let currentGameMode = null;
        let currentPlayerSymbol = null;
        let pollInterval = null;
        let currentUserLogin = null;
        let currentUserPassword = null;
        let currentUserUUID = null;

        let accessToken = null;


        function getAuthHeader() {
            if (!currentUserLogin || !currentUserPassword) return {};
            const credentials = btoa(`${currentUserLogin}:${currentUserPassword}`);
            return { 'Authorization': `Basic ${credentials}` };
        }

        async function register() {
            const login = document.getElementById('login').value.trim();
            const password = document.getElementById('password').value;
            if (login.length < 3 || password.length < 6) {
                alert('–õ–æ–≥–∏–Ω –º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞, –ø–∞—Ä–æ–ª—å –º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }

            try {
                const res = await fetch(`${API_BASE_URL}/registration`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ login, password })
                });

                if (res.ok) {
                    alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.');
                    document.getElementById('password').value = '';
                } else {
                    const err = await res.text();
                    alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + (err || '–Ω–µ–≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å'));
                }
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
            }
        }

        async function login() {
            const login = document.getElementById('login').value.trim();
            const password = document.getElementById('password').value;
            if (!login || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            try {
                const res = await fetch(`${API_BASE_URL}/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ login, password })
                });

                const authData = await res.json();

                if (res.ok) {

                    currentUserLogin = login;
                    currentUserUUID = authData.uuid;
                    accessToken = authData.access_token
                    document.getElementById('authScreen').style.display = 'none';
                    document.getElementById('gameScreen').style.display = 'block';
                    document.getElementById('userLogin').textContent = login;
                    initializeBoard();
                    renderModeSelector();
                } else {
                    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
                }
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
            }
        }

        function getAuthHeader() {
            if (!accessToken) {
                throw new Error('Not authenticated');
            }
            return { 'Authorization': `Bearer ${accessToken}` };
        }

        // === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ì–†–´ ===

        async function createGame(mode) {
            try {
                const response = await fetch(`${API_BASE_URL}/game/new`, {
                    method: 'POST',
                    headers: getAuthHeader(),
                    body: JSON.stringify({ withBot: true })
                });
                document.getElementById('gameScreen').style.display = 'block';
                const responseText = await response.text();
                let data;

                if (!response.ok) {
                    try {
                        data = JSON.parse(responseText);
                        const msg = data.message || data.error || responseText || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                        throw new Error(msg);
                    } catch (e) {
                        throw new Error(responseText || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                    }
                }

                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π JSON: ' + responseText);
                }

                if (!data.uuid || !data.field || !Array.isArray(data.field.field)) {
                    console.error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–≥—Ä—ã:', data);
                    throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –∏–≥—Ä—É –≤ –Ω–µ–≤–µ—Ä–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ');
                }

                // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å –±–æ—Ç–æ–º ‚Äî –≤—ã –≤—Å–µ–≥–¥–∞ X
                // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–µ–∑ –±–æ—Ç–∞ ‚Äî –≤—ã X, –Ω–æ –∏–≥—Ä–∞ –≤ —Å—Ç–∞—Ç—É—Å–µ waiting
                setupGame(data, 'bot', true);
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã:', err);
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã: ' + err.message);
            }
        }

        // –°–æ–∑–¥–∞—Ç—å –ü–£–ë–õ–ò–ß–ù–£–Æ –∏–≥—Ä—É (–¥–ª—è –ª—é–¥–µ–π)
        async function createPublicGame() {
            document.getElementById('gameScreen').style.display = 'block';
            try {
                const response = await fetch(`${API_BASE_URL}/game/new`, {
                    method: 'POST',
                    headers: getAuthHeader(),
                    body: JSON.stringify({ with_bot: false }) // –±–µ–∑ –±–æ—Ç–∞ ‚Üí –ø—É–±–ª–∏—á–Ω–∞—è
                });

                const responseText = await response.text();
                let data;

                if (!response.ok) {
                    try {
                        data = JSON.parse(responseText);
                        const msg = data.message || data.error || responseText || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É';
                        throw new Error(msg);
                    } catch (e) {
                        throw new Error(responseText || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É');
                    }
                }

                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π JSON: ' + responseText);
                }

                if (!data.uuid || !data.field || !Array.isArray(data.field.field)) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–≥—Ä—ã');
                }

                if (data.status_game === 'waiting') {
                    alert(`–ò–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞! ID: ${data.uuid}. –ñ–¥—ë–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...`);
                    // –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è ‚Äî –≤—ã –æ—Å—Ç–∞—ë—Ç–µ—Å—å –≤ —Å–ø–∏—Å–∫–µ, –∂–¥—ë—Ç–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                    showAvailableGames(); // –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                } else {
                    // –ï—Å–ª–∏ –∏–≥—Ä–∞ —Å—Ä–∞–∑—É –Ω–∞—á–∞–ª–∞—Å—å (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                    setupGame(data, 'human', true);
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—É–±–ª–∏—á–Ω–æ–π –∏–≥—Ä—ã:', err);
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        async function showAvailableGames() {
            try {
                const response = await fetch(`${API_BASE_URL}/game/list`, {
                    headers: getAuthHeader()
                });

                if (!response.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–≥—Ä—ã: ' + response.status);
                }

                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π JSON');
                }

                const games = Array.isArray(data) ? data : [];
                showGamesList(games);
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä:', err);
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        function showGamesList(games) {
            const controls = document.getElementById('controls');
            let html = '<h3>üë• –ò–≥—Ä–∞ —Å —á–µ–ª–æ–≤–µ–∫–æ–º</h3>';
            html += '<button onclick="createPublicGame()">‚ûï –°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</button><br><br>';

            if (games.length === 0) {
                html += '<p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–≥—Ä. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é!</p>';
            } else {
                html += '<p>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–≥—Ä—ã:</p>';
                games.forEach(game => {
                    if (game && game.uuid) {
                        html += `<button onclick="joinGame('${String(game.uuid)}')">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ ${String(game.uuid).slice(0, 8)}...</button><br><br>`;
                    }
                });
            }
            html += '<button onclick="renderModeSelector()">‚Üê –ù–∞–∑–∞–¥</button>';
            controls.innerHTML = html;
        }

        async function joinGame(gameId) {
            try {
                const response = await fetch(`${API_BASE_URL}/game/${gameId}/join`, {
                    method: 'POST',
                    headers: getAuthHeader(),
                });

                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π JSON');
                }

                if (!response.ok) {
                    const msg = data.message || data.error || (await response.text()) || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è';
                    throw new Error(msg);
                }

                if (!data.uuid || !data.field || !Array.isArray(data.field.field)) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–≥—Ä—ã');
                }

                // –ü—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ ‚Äî –≤—ã O
                setupGame(data, 'human', false);
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', err);
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        async function makeMove(row, col) {
            if (!currentGameId) {
                alert('–ù–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É!');
                return;
            }
            const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            if (!cell || cell.textContent !== '') return;

            setLoading(true);
            try {
                const field = getCurrentBoardState();
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ö–æ–¥–∞: 1 –¥–ª—è X, 2 –¥–ª—è O
                field[row][col] = currentPlayerSymbol === 'X' ? 1 : 2;

                const response = await fetch(`${API_BASE_URL}/game/${currentGameId}`, {
                    method: 'POST',
                    headers: {
                        ...getAuthHeader(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        uuid: currentGameId,
                        field: { field }
                    })
                });

                // –°–Ω–∞—á–∞–ª–∞ —á–∏—Ç–∞–µ–º —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –∏ –¥–ª—è JSON, –∏ –¥–ª—è –æ—à–∏–±–æ–∫
                const responseText = await response.text();
                let data;

                if (!response.ok) {
                    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –ø—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
                    try {
                        data = JSON.parse(responseText);
                        const msg = data.message || data.error || responseText || '–û—à–∏–±–∫–∞ —Ö–æ–¥–∞';
                        throw new Error(msg);
                    } catch (e) {
                        // –ï—Å–ª–∏ –Ω–µ JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
                        throw new Error(responseText || '–û—à–∏–±–∫–∞ —Ö–æ–¥–∞');
                    }
                }

                // –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, –ø–∞—Ä—Å–∏–º JSON
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π JSON: ' + responseText);
                }

                if (!data.field || !Array.isArray(data.field.field)) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–æ–ª—è –ø–æ—Å–ª–µ —Ö–æ–¥–∞');
                }

                updateGameState(data);

                // –ï—Å–ª–∏ –∏–≥—Ä–∞ —Å —á–µ–ª–æ–≤–µ–∫–æ–º –∏ –∏–≥—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–ø—Ä–æ—Å
                if (currentGameMode === 'human' && data.status_game === 'in_progress') {
                    startPolling();
                } else if (data.status_game !== 'in_progress') {
                    // –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø—Ä–æ—Å
                    if (pollInterval) clearInterval(pollInterval);
                }

            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Ö–æ–¥–∞:', err);
                alert('–û—à–∏–±–∫–∞ —Ö–æ–¥–∞: ' + err.message);
            } finally {
                setLoading(false);
            }
        }

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(async () => {
                try {
                    const res = await fetch(`${API_BASE_URL}/game/${currentGameId}/status`, {
                        headers: getAuthHeader()
                    });
                    if (res.ok) {
                        const game = await res.json();
                        if (game.uuid === currentGameId) {
                            updateGameState(game);
                            if (game.status_game !== 'in_progress') {
                                clearInterval(pollInterval);
                            }
                        }
                    }
                } catch (e) {
                    console.warn('Polling error:', e);
                }
            }, 2000);
        }

        function initializeBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const cell = document.createElement('button');
                    cell.className = 'cell';
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    cell.addEventListener('click', () => makeMove(i, j));
                    board.appendChild(cell);
                }
            }
        }

        function renderModeSelector() {
            hideGameBoard();

            const controls = document.getElementById('controls');
            controls.innerHTML = `
        <button onclick="createGame('bot')">üéÆ –ò–≥—Ä–∞ —Å –±–æ—Ç–æ–º</button>
        <button onclick="showAvailableGames()">üë• –ò–≥—Ä–∞ —Å —á–µ–ª–æ–≤–µ–∫–æ–º</button>
        <button onclick="fetchLeaderboard()">üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</button>
        <button onclick="fetchGameHistory()">üìú –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</button>
        <button onclick="fetchMyProfile()">üë§ –ú–æ–∏ –¥–∞–Ω–Ω—ã–µ</button>
        <button onclick="resetGame()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
    `;
            document.getElementById('status').textContent = '–°—Ç–∞—Ç—É—Å: –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º';
            document.getElementById('message').textContent = '–£–¥–∞—á–∏! üíñ';
            document.getElementById('gameId').textContent = '-';
            currentGameId = null;
            if (pollInterval) clearInterval(pollInterval);
        }

        //—Å–∫—Ä—ã—Ç–∏–µ –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
        function hideGameBoard() {
            document.getElementById('board').style.display = 'none';
        }

        function showGameBoard() {
            document.getElementById('board').style.display = 'grid'; // –∏–ª–∏ 'block', –∫–∞–∫ –≤ CSS
        }


        async function fetchLeaderboard() {
            const n = prompt('–°–∫–æ–ª—å–∫–æ –ª—É—á—à–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –ø–æ–∫–∞–∑–∞—Ç—å?', '10');
            if (!n || isNaN(n) || n <= 0) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ.');
                return;
            }
            hideGameBoard();

            try {
                const response = await fetch(`${API_BASE_URL}/game/leaders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeader()
                    },
                    body: JSON.stringify({ count: parseInt(n, 10) })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`–û—à–∏–±–∫–∞ ${response.status}: ${errorText}`);
                }

                const leaderboard = await response.json(); // [{ uuid: "...", login: "...", win_ratio: 0.85 }, ...]

                let html = '<h3>üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h3><ul>';
                leaderboard.forEach(player => {
                    html += `<li>${player.Login} (UUID: ${player.UserId}) ‚Äî –ø–æ–±–µ–¥: ${player.WinRate}%</li>`;
                });
                html += '</ul><button onclick="renderModeSelector()">‚Üê –ù–∞–∑–∞–¥</button>';

                document.getElementById('controls').innerHTML = html;
                document.getElementById('status').textContent = '–°—Ç–∞—Ç—É—Å: –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–∞';
                document.getElementById('message').textContent = '';
                document.getElementById('gameId').textContent = '-';

            } catch (err) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤: ' + err.message);
                console.error(err);
            }
        }
        async function fetchGameHistory() {
             hideGameBoard();
            try {
                const response = await fetch(`${API_BASE_URL}/game/history`, {
                    method: 'GET',
                    headers: getAuthHeader()
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`–û—à–∏–±–∫–∞ ${response.status}: ${errorText}`);
                }

                const games = await response.json(); // –º–∞—Å—Å–∏–≤ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∏–≥—Ä

                if (games.length === 0) {
                    document.getElementById('controls').innerHTML = `
                <p>–ù–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∏–≥—Ä.</p>
                <button onclick="renderModeSelector()">‚Üê –ù–∞–∑–∞–¥</button>
            `;
                } else {
                    let html = '<h3>üìú –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</h3><ul>';
                    games.forEach(game => {
                        let result;
                        if (game.status_game === 'won_X' || game.status_game === 'won_O') {
                            result = '‚úÖ –ü–æ–±–µ–¥–∞';
                        } else if (game.status_game === 'draw') {
                            result = '‚ûñ –ù–∏—á—å—è';
                        } else {
                            result = '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                        }

                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞
                        const isPlayerX = game.player_x !== null;
                        const isPlayerO = game.player_o !== null;
                        let opponent = '–±–æ—Ç–∞';

                        // –ï—Å–ª–∏ –æ–±–∞ –∏–≥—Ä–æ–∫–∞ ‚Äî –Ω–µ –±–æ—Ç (—Ä–µ–¥–∫–æ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ)
                        if (isPlayerX && isPlayerO) {
                            // –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –æ–¥–∏–Ω –∏–∑ –Ω–∏—Ö, –∑–Ω–∞—á–∏—Ç, –¥—Ä—É–≥–æ–π ‚Äî —á–µ–ª–æ–≤–µ–∫
                            opponent = '–∏–≥—Ä–æ–∫–∞';
                        }
                        // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ player_x ‚Äî –∑–Ω–∞—á–∏—Ç, —Ç—ã X, –ø—Ä–æ—Ç–∏–≤ –±–æ—Ç–∞ (player_o = null)
                        // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ player_o ‚Äî –∑–Ω–∞—á–∏—Ç, —Ç—ã O, –ø—Ä–æ—Ç–∏–≤ –±–æ—Ç–∞ (player_x ‚Äî –±–æ—Ç? –Ω–æ –≤ —Ç–≤–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö player_x –≤—Å–µ–≥–¥–∞ UUID)
                        // –í —Ç–≤–æ—ë–º —Å–ª—É—á–∞–µ: –µ—Å–ª–∏ player_o === null ‚Üí –ø—Ä–æ—Ç–∏–≤ –±–æ—Ç–∞

                        if (game.player_o === null || game.player_x === null) {
                            opponent = '–±–æ—Ç';
                        } else {
                            opponent = '–∏–≥—Ä–æ–∫';
                        }

                        html += `<li>–ò–≥—Ä–∞ ${game.uuid}: –ø—Ä–æ—Ç–∏–≤ ${opponent} ‚Äî ${result}</li>`;
                    });
                    html += '</ul><button onclick="renderModeSelector()">‚Üê –ù–∞–∑–∞–¥</button>';
                    document.getElementById('controls').innerHTML = html;
                }

                document.getElementById('status').textContent = '–°—Ç–∞—Ç—É—Å: –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–∞';
                document.getElementById('message').textContent = '';
                document.getElementById('gameId').textContent = '-';

            } catch (err) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–≥—Ä: ' + err.message);
                console.error(err);
            }
        }

        async function fetchMyProfile() {
            hideGameBoard();
            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    method: 'GET',
                    headers: getAuthHeader()
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`–û—à–∏–±–∫–∞ ${response.status}: ${errorText}`);
                }

                const user = await response.json(); // { uuid: "...", login: "..." }

                const html = `
            <h3>üë§ –ú–æ–∏ –¥–∞–Ω–Ω—ã–µ</h3>
            <p><strong>–õ–æ–≥–∏–Ω:</strong> ${user.login}</p>
            <p><strong>UUID:</strong> ${user.uuid}</p>
            <button onclick="renderModeSelector()">‚Üê –ù–∞–∑–∞–¥</button>
        `;

                document.getElementById('controls').innerHTML = html;
                document.getElementById('status').textContent = '–°—Ç–∞—Ç—É—Å: –ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω';
                document.getElementById('message').textContent = '';
                document.getElementById('gameId').textContent = '-';

            } catch (err) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è: ' + err.message);
                console.error(err);
            }
        }

        function setupGame(game, mode, isPlayerX) {
            showGameBoard();        // ‚Üê —Ç–µ–ø–µ—Ä—å —ç—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç #board
            initializeBoard();
            currentGameId = game.uuid;
            currentGameMode = mode;
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–∏–º–≤–æ–ª –∏–≥—Ä–æ–∫–∞: –µ—Å–ª–∏ –º—ã player_x, —Ç–æ X, –µ—Å–ª–∏ player_o - —Ç–æ O
            if (currentUserUUID) {
                if (game.player_x === currentUserUUID) {
                    currentPlayerSymbol = 'X';
                } else if (game.player_o && game.player_o === currentUserUUID) {
                    currentPlayerSymbol = 'O';
                } else {
                    // Fallback –Ω–∞ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
                    currentPlayerSymbol = isPlayerX ? 'X' : 'O';
                }
            } else {
                currentPlayerSymbol = isPlayerX ? 'X' : 'O';
            }
            updateGameState(game);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫—É "–≤—ã–π—Ç–∏"
            const controls = document.getElementById('controls');
            controls.innerHTML = '<button onclick="resetGame()">üö™ –í—ã–π—Ç–∏ –∏–∑ –∏–≥—Ä—ã</button>';

            if (mode === 'human') {
                startPolling();
            }
        }

        function updateGameState(game) {
            document.getElementById('gameId').textContent = String(game.uuid || '-');
            let statusText = '–ò–≥—Ä–∞ –∏–¥–µ—Ç üå∏';
            if (game.status === 4) {
                statusText = '–ù–∏—á—å—è! ü§ù';
            } else if (game.status === 2 || game.status === 3) {
                statusText = '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞ üéâ';
            } else if (game.status === 0) {
                statusText = '–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...';
            }
            document.getElementById('status').textContent = `–°—Ç–∞—Ç—É—Å: ${statusText}`;
            document.getElementById('message').textContent = game.status === 1 ? (game.message || '–í–∞—à —Ö–æ–¥! üíñ') : (game.message || '');

            const field = game.field?.field;
            if (Array.isArray(field) && field.length === 3) {
                updateBoard(field);
            } else {
                console.error('–ù–µ–≤–µ—Ä–Ω–æ–µ –ø–æ–ª–µ:', game);
            }
        }

        function updateBoard(field) {
            const cells = document.querySelectorAll('.cell');
            cells.forEach((cell, idx) => {
                const r = Math.floor(idx / 3);
                const c = idx % 3;
                cell.textContent = '';
                cell.className = 'cell';
                const val = field[r]?.[c];
                if (val === 1) {
                    cell.textContent = 'X';
                    cell.classList.add('x');
                } else if (val === 2) {
                    cell.textContent = 'O';
                    cell.classList.add('o');
                }
            });
        }

        function getCurrentBoardState() {
            const state = [[0, 0, 0], [0, 0, 0], [0, 0, 0]];
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const txt = document.querySelector(`.cell[data-row="${i}"][data-col="${j}"]`)?.textContent || '';
                    state[i][j] = txt === 'X' ? 1 : (txt === 'O' ? 2 : 0);
                }
            }
            return state;
        }

        function setLoading(loading) {
            document.querySelectorAll('button').forEach(btn => {
                if (btn) btn.disabled = loading;
            });
        }

        function resetGame() {
            currentGameId = null;
            currentGameMode = null;
            currentPlayerSymbol = null;
            if (pollInterval) clearInterval(pollInterval);

            // document.getElementById('board').innerHTML = '';

            // 2. –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
            document.getElementById('status').textContent = '–°—Ç–∞—Ç—É—Å: –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º';
            document.getElementById('message').textContent = '–£–¥–∞—á–∏! üíñ';
            document.getElementById('gameId').textContent = '-';
            document.getElementById('userLogin').textContent = '-';

            // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞
            renderModeSelector(); // —ç—Ç–æ –æ–±–Ω–æ–≤–∏—Ç #controls

        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ window
        window.register = register;
        window.login = login;
        window.createGame = createGame;
        window.createPublicGame = createPublicGame;
        window.showAvailableGames = showAvailableGames;
        window.joinGame = joinGame;
        window.renderModeSelector = renderModeSelector;
        window.resetGame = resetGame;
    </script>
</body>

</html>